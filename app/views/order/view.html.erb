
<% order_count = 0 %>
<% unit_cost = 0 %>
<% sub_total = 0 %>
<% sub_multiplier = 0%>
<% original_total = 0%>
<%@order = session[:order]%>

<%if session[:order].nil? %>
    <h1>Whoops something went wrong</h1>

<%else%>

<% small_keys = [] %>
<% keys = @order.attributes.keys%>
    <% keys.each do |subs| %>
        <% if subs.include? "size" %>
            <% small_keys.push subs %>
        <%end%>
    <% end %>




<div class="container">
  <div class="row">
    <!-- Invoice -->
      <div class="p-3 col-md-8">
          <%# <div class="row"> %>
              <div class="col-12">
                  <div class="card">
                      <div class="card-body p-0">
                          <div class="row p-5">
                              <h4>Subscription Checkout for <%= @order.shipping_address %></h4>
                              <%= form_for(:anything, url: dash_path, method: :get) do |g| %>
                                  <%=g.submit "Go to dash board", class: "btn btn-link px-5"%>
                              <%end%>
                          </div>

                          <hr class="my-1">
                          <div class="row pb-2 p-5">
                              <div class="col-md-6">
                                  <p class="font-weight-bold mb-2">Property Info</p>
                                  <p class="mb-1"><%= @order.tenant_name %></p>
                                
                                  <p class="mb-1"><%= @order.shipping_address %> </p>
                                  <p class="mb-1"><%= @order.city %>, <%= @order.state %> <%= @order.zipcode %> </p>
                                  <p class="mb-1">United States</p>
                              </div>

                              <div class="col-md-6 text-right">
                                  <p class="font-weight-bold mb-2">Order Details</p>
                                  <p class="mb-1"><span class="text-muted">Ship on: </span> <%= @order.start_date %></p>
                                  <p class="mb-1"><span class="text-muted">Frequency: </span> Every <%= @order.filter_freq%> month(s)</p>
                                  <p class="mb-1"><span class="text-muted">Subscription:  </span> Every <%= @order.sub_freq%> month(s) </p>
                                  <p class="mb-1"><span class="text-muted"></span> </p>
                              </div>
                          </div>

                          <div class="row p-2">
                              <div class="col-md-12">
                                  <table class="table">
                                      <thead>
                                          <tr>
                                              <th class="border-0 text-uppercase small font-weight-bold">Item No.</th>
                                              <th class="border-0 text-uppercase small font-weight-bold">Filter Size</th>
                                              <th class="border-0 text-uppercase small font-weight-bold">Quantity</th>
                                              <th class="border-0 text-uppercase small font-weight-bold">Unit Cost</th>
                                              <th class="border-0 text-uppercase small font-weight-bold">Total</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          <% small_keys.each do |key|%>
                                            <% order_count += 1 %>
                                            <tr>
                                                <% if(@order.attributes[key]) %>
                                                    <td><%=order_count%></td>
                                                    <td><%="#{session[:sizes][key]}" %></td>
                                                    <td><%= "#{@order.attributes[key]} units" %></td>
                                                    <% unit_cost = session[:price_hash][key]*@order.attributes[key] / @order.attributes[key] %>
                                                    <td><%= "$#{'%.2f' % unit_cost}"%>
                                                    <td><%= "$#{session[:price_hash][key]*@order.attributes[key]}" %></td>
                                                <% end %>
                                            <% end %>
                                            </tr>
                                      </tbody>
                                  </table>
                              </div>
                          </div>

                          <div class="d-flex flex-row-reverse bg-dark text-white p-4">
                              <div class="py-3 px-5 text-right">
                                  <div class="mb-2">Total</div>
                                  <div class="h2 font-weight-light"><%="$#{'%.2f' % @order.price}"%></div>
                              </div>
                              <%# <%session[:order] = @order%> 
                          </div>
                      </div>
                  </div>
              </div>
          <%# </div> %>
      </div>


    <!-- Review Order -->
    <div class="card h-100 col-sm-3">
        <div class="panel panel-default">
            <div class="panel-heading text-center">
                <br>
                <h4>Review Order</h4>
            </div>
            
            <div class="panel-body">
                  <div class="col-md-12">
                      <strong>Subtotal</strong>
                      <% sub_total = (@order.price - 7)/(@order.sub_freq/@order.filter_freq) %>
                      <div class="pull-right">$<span><%="#{'%.2f' % sub_total}"%></span></div>
                      <hr>
                  </div>

                  <div class="col-md-12">
                      <% sub_multiplier = @order.sub_freq / @order.filter_freq%>
                      <small>Subscription</small>
                      <div class="pull-right"><span><%="$#{'%.2f' % sub_total}"%>  x <%=sub_multiplier%></span></div>
                      <hr>
                  </div>

                  <div class="col-md-12">
                      <small>Shipping</small>
                      <div class="pull-right"><span>+ $7.00</span></div>
                      <hr>
                  </div>

                  <div class="col-md-12">
                      <strong>Order Total</strong>
                      <div class="pull-right"><span>$</span><span><%="#{'%.2f' % @order.price}"%></span></div>
                      <hr>
                  </div>

                  <div class="col-md-12 text-center">
                      <strong>Pay with Paypal</strong>
                      <br><br>
                  </div>

                  <!-- Paypal Stuff-->
                  <script
                    src="https://www.paypal.com/sdk/js?client-id=AYEvKhOwg3t1wPfRKErTkTWRRCpbhMU1-cOMcoBl2P4LydSk55VrkNnNUkm32LRuxtYF1sXNZlv-s6w7">
                  </script>

                  <div id="paypal-button-container"></div>
                  <script>
                    var price = <%= @order.price %>;
                    paypal.Buttons({
                      //Set up transaction
                      createOrder: function(data, actions) {
                        return actions.order.create({
                          purchase_units: [{
                            amount: {
                              value: price
                            }
                          }]
                        });
                    },

                    //Finalize the transaction
                    onApprove: function(data, actions) {
                      return actions.order.capture().then(function(details) {
                        alert('Transaction completed by ' + details.payer.name.given_name);
                        window.location.replace("http://localhost:3000/orders_page");
                        // Call your server to save the transaction
                        return fetch('/paypal', {
                          method: 'post',
                          headers: {
                            'content-type': 'application/json'
                          },
                          body: JSON.stringify({
                            orderID: data.orderID
                          })
                        });
                        //window.location.replace("http://localhost:3000/orders_page");
                      });
                    }
                  }).render('#paypal-button-container');
                  </script>   
            </div>  
        </div>
    </div>
  </div> 


</div>
<%end%>
          




